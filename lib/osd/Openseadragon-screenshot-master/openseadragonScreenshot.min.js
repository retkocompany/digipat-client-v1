!function(d){"use strict";if(!d.version||d.version.major<2)throw new Error("This version of OpenSeadragonScreenshot requires OpenSeadragon version 2.0.0+");function u(){this.closeMenu()}d.Viewer.prototype.screenshot=function(e){return this.screenshotInstance&&!e||(((e=e||{}).viewer=this).screenshotInstance=new d.Screenshot(e)),this.screenshotInstance},d.Screenshot=function(e){if(d.extend(!0,this,{viewer:null,buttonActiveImg:!1,screenshotWidth:1e3,screenshotHeight:1e3,showingMenu:!1,makingScreenshot:!1,menuDiv:null,loadingDiv:null,toggleButton:null,navImages:{screenshot:{REST:"selection_rest.png",GROUP:"selection_grouphover.png",HOVER:"selection_hover.png",DOWN:"selection_pressed.png"}},showOptions:!1,showScreenshotControl:!0,keyboardShortcut:null},e),d.extend(!0,this.navImages,this.viewer.navImages),this.loadingDiv||(this.loadingDiv=document.createElement("div"),this.loadingDiv.style.background="rgba(1,1,1, 0.3)",(i=document.createElement("img")).src=this.viewer.prefixUrl+"ajax_loader_gray_32.gif",i.setAttribute("crossOrigin","anonymous"),this.loadingDiv.style.position="absolute",this.loadingDiv.style.top="0px",this.loadingDiv.style.left="0px",this.loadingDiv.style.width=this.viewer.viewport.containerSize.x+"px",this.loadingDiv.style.height=this.viewer.viewport.containerSize.y+"px",this.loadingDiv.style.backgroundColor="#fff",(l=document.createElement("div")).appendChild(i),l.style.margin="-16px 0 0 -16px",l.style.position="absolute",l.style.top=Math.round(this.viewer.viewport.containerSize.y/2)+"px",l.style.left=Math.round(this.viewer.viewport.containerSize.x/2)+"px",l.innerHTML+="Loading image... <br>Takes too long?<br>",(i=document.createElement("button")).onclick=function(){window.location.reload()},i.innerHTML="Refresh page",l.appendChild(i),this.loadingDiv.appendChild(l),document.body.appendChild(this.loadingDiv),this.loadingDiv.className="screenshot-box",this.loadingDiv.style.display="none"),this.showOptions&&!this.menuDiv){var t=this.viewer.container,n=document.createElement("div");n.style.position="absolute",n.style.backgroundColor="#f3f3f3",n.style.width="30%",n.style.minWidth="400px",n.style.padding="20px",n.style.margin="-100px 0 0 -200px",n.style.top="50%",n.style.left="50%",n.style.fontFamily="Tahoma,Arial,sans-serif";var i=document.createElement("a");i.style.position="absolute",i.innerHTML="&times;",i.style.position="absolute",i.style.top="20px",i.style.right="30px",i.style.fontSize="30px",i.style.fontWeight="bold",i.style.textDecoration="none",i.style.color="#333",i.style.cursor="pointer",i.id="screenshotCloseButton";var s=document.createElement("p");s.id="screenshotTextMessage",s.display="block";var o=document.createElement("div"),r=[],h=document.createElement("div");h.style.fontSize="20px",h.style.lineHeight="20px",r.push(h);var l=document.createElement("input");l.type="radio",l.name="screenshotForm",l.style.height="25px",l.id="screenshotZFCheck",l.setAttribute("checked",!0),h.appendChild(l),h.innerHTML+="Zoom factor:";l=document.createElement("input");l.type="range",l.id="screenshotZFInput",l.max="3",l.min="0.25",l.step="0.25",h.appendChild(l);l=document.createElement("span");l.setAttribute("id","screenshotZFDisplay"),l.setAttribute("value","1"),h.appendChild(l),h.innerHTML+=" times",(h=document.createElement("div")).style.fontSize="20px",h.style.lineHeight="20px",r.push(h);var a,l=document.createElement("input");l.type="radio",l.style.height="25px",l.id="screenshotUseVpSize",l.name="screenshotForm",h.appendChild(l),h.innerHTML+="Just take a screenshot",this.viewer.annotationInstance&&(h=document.createElement("div"),r.push(h),(a=document.createElement("input")).type="checkbox",a.style.height="25px",a.id="screenshotDrawArrows",h.appendChild(a),h.innerHTML+="Also draw annotations"),this.viewer.scalebarInstance&&(h=document.createElement("div"),r.push(h),(a=document.createElement("input")).type="checkbox",a.style.height="25px",a.id="screenshotDrawScalebar",h.appendChild(a),h.innerHTML+="Draw scalebar as well");h=document.createElement("button");h.innerHTML="Download image",h.onclick=this.takeScreenshot.bind(this,h),h.ontouchstart=this.takeScreenshot.bind(this,h),h.style.height="40px",h.style.lineHeight="30px",h.style.fontSize="24px",h.style.margin="0 auto",h.style.display="block";for(var c=r.length-1;0<=c;c--)o.appendChild(r[c]);n.appendChild(i),n.appendChild(o),n.appendChild(s),n.appendChild(h),t.appendChild(n),this.showingMenu=!1,this.menuDiv=n,this.menuDiv.style.display="none",document.getElementById("screenshotZFCheck").onchange=this.menuUpdate.bind(this),document.getElementById("screenshotZFInput").onchange=this.menuUpdate.bind(this),document.getElementById("screenshotZFInput").oninput=this.menuUpdate.bind(this),document.getElementById("screenshotUseVpSize").onchange=this.menuUpdate.bind(this),document.getElementById("screenshotCloseButton").onclick=this.closeMenu.bind(this)}s=this.prefixUrl||this.viewer.prefixUrl||"",h=this.viewer.buttons&&this.viewer.buttons.buttons,t=h?this.viewer.buttons.buttons[0]:null,n=t?t.onFocus:null,t=t?t.onBlur:null;this.showScreenshotControl&&(this.toggleButton=new d.Button({element:this.toggleButton?d.getElement(this.toggleButton):null,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,tooltip:d.getString("Tooltips.ScreenshotToggle")||"Make Screenshot",srcRest:s+this.navImages.screenshot.REST,srcGroup:s+this.navImages.screenshot.GROUP,srcHover:s+this.navImages.screenshot.HOVER,srcDown:s+this.navImages.screenshot.DOWN,onRelease:this.toggleScreenshotMenu.bind(this),onFocus:n,onBlur:t}),h&&(this.viewer.buttons.buttons.push(this.toggleButton),this.viewer.buttons.element.appendChild(this.toggleButton.element)),this.toggleButton.imgDown&&(this.buttonActiveImg=this.toggleButton.imgDown.cloneNode(!0),this.toggleButton.element.appendChild(this.buttonActiveImg))),this.outerTracker=new d.MouseTracker({element:this.viewer.drawer.canvas,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,clickHandler:d.delegate(this,u),startDisabled:!this.showingMenu})},d.extend(d.Screenshot.prototype,d.ControlDock.prototype,{closeMenu:function(){return this.menuDiv&&(this.menuDiv.style.display="none"),this.showingMenu=!1,this.outerTracker.setTracking(!1),!0},takeScreenshot:function(){this.loadingDiv.style.display="inline";var e=this.viewer.viewport.containerSize,s=e.x,o=e.y,t=this.screenshotWidth,e=this.screenshotHeight;this.showOptions&&(this.viewer.viewport.getMaxZoom(),this.viewer.viewport.getZoom(),this.viewer.element.style.height=e+"px",this.viewer.element.style.width=t+"px",this.closeMenu());function n(){r.world.getItemAt(0).removeAllHandlers("fully-loaded-change"),h.style.display="none";var e,t,n,i=null;r.screenshotInstance.showOptions&&r.scalebarInstance&&document.getElementById("screenshotDrawScalebar").checked?(n=r.drawer.canvas,(i=document.createElement("canvas")).width=n.width,i.height=n.height,console.log(n.width+"/"+n.height),(e=i.getContext("2d")).drawImage(n,0,0),screenshotDrawArrows&&r.annotationInstance&&r.annotationInstance.drawArrowsOnCanvas(i),t=r.scalebarInstance.getAsCanvas(),n=r.scalebarInstance.getScalebarLocation(),e.drawImage(t,n.x,n.y)):i=r.drawer.canvas,i.toBlob(function(e){saveAs(e,"screenshot.png"),r.element.style.height=o+"px",r.element.style.width=s+"px"})}var r=this.viewer,h=this.loadingDiv;return this.showOptions?requestAnimationFrame(function(){r.forceRedraw(),r.world.getItemAt(0).getFullyLoaded()?n():r.world.getItemAt(0).addHandler("fully-loaded-change",n)}):r.world.getItemAt(0).getFullyLoaded()?n():r.world.getItemAt(0).addHandler("fully-loaded-change",n),!0},toggleScreenshotMenu:function(){return this.showOptions?(this.outerTracker.setTracking(!this.showingMenu),this.showingMenu?this.closeMenu.bind(this):(this.showMenu(),this.menuUpdate()),!0):(this.takeScreenshot(),!0)},showMenu:function(){this.menuDiv.style.display="inline",this.showingMenu=!0},menuUpdate:function(){var e,t,n;this.viewer.viewport.containerSize.y,this.viewer.viewport.containerSize.x,document.getElementById("screenshotZFCheck").checked;document.getElementById("screenshotUseVpSize").checked?(this.screenshotWidth=this.viewer.viewport.containerSize.x,this.screenshotHeight=this.viewer.viewport.containerSize.y):(e=document.getElementById("screenshotZFInput").value,t=this.viewer.viewport.containerSize.x,n=this.viewer.viewport.containerSize.y,this.screenshotWidth=t*e,this.screenshotHeight=n*e,document.getElementById("screenshotZFDisplay").innerHTML=e),document.getElementById("screenshotTextMessage").innerHTML="Size of download: "+Math.round(this.screenshotWidth)+"x"+Math.round(this.screenshotHeight)}})}(OpenSeadragon);